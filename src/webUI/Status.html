<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>BambuBeacon</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div id="container">
    <div id="header">
      <a href="/"><img id="logo" src="/logo.svg" alt="Logo" /></a>
      <h1>BambuBeacon</h1>
    </div>

    <div class="panel" id="updateNotice" style="display:none;">
      <div class="panel-title">Update available</div>
      <div class="button-stack actions">
        <button class="btn" id="updateNoticeBtn" onclick="location.href='/maintenance'">Open Maintenance</button>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">LED Brightness</div>
      <div class="slider-row">
        <input type="range" id="ledBrightness" min="0" max="100" step="1" />
        <div class="slider-value" id="ledBrightnessValue">--</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Device</div>
      <div id="deviceInfo" style="color: var(--bb-text-2); font-weight: 650;">Loading…</div>
    </div>

    <div class="panel">
      <div class="panel-title">Setup</div>
      <div class="button-stack">
        <button class="btn btn-outline" onclick="location.href='/wifisetup'">Wi-Fi / Network</button>
        <button class="btn btn-outline" onclick="location.href='/printersetup'">Printer Setup</button>
        <button class="btn btn-outline" onclick="location.href='/maintenance'">Maintenance</button>
        <button class="btn btn-outline" onclick="window.open('/webserial','_blank','noopener')">Debug Log</button>
      </div>
    </div>
  </div>

  <div id="toast"><span id="toast-icon">ℹ️</span><span id="toast-msg">Placeholder</span></div>
  <div class="page-footer" id="fwFooter">Firmware v? by SoftWareCrash</div>

  <script src="/backgroundCanvas.js"></script>
  <script>
    async function loadInfo() {
      try {
        const r = await fetch("/info.json");
        const j = await r.json();
        const el = document.getElementById("deviceInfo");
        el.innerHTML =
          `Name: <b>${j.deviceName || "BambuBeacon"}</b><br>` +
          `Mode: <b>${j.mode || "?"}</b><br>` +
          `IP: <b>${j.ip || "?"}</b><br>` +
          `RSSI: <b>${(j.rssi != null ? j.rssi : "?")}</b>`;
      } catch {
        document.getElementById("deviceInfo").textContent = "Failed to load device info.";
      }
    }
    loadInfo();

    async function loadUpdateNotice() {
      try {
        const r = await fetch("/ota/status", { cache: "no-store" });
        if (!r.ok) return;
        const j = await r.json();
        if (j && j.state === "update_available") {
          const panel = document.getElementById("updateNotice");
          const btn = document.getElementById("updateNoticeBtn");
          const cur = j.current || "";
          const latest = j.latest || "";
          if (cur && latest) {
            btn.textContent = `Update ${cur} → ${latest} available`;
          } else if (latest) {
            btn.textContent = `Update to ${latest} available`;
          } else {
            btn.textContent = "Update available";
          }
          panel.style.display = "";
        }
      } catch {}
    }
    loadUpdateNotice();

    const ledSlider = document.getElementById("ledBrightness");
    const ledValue = document.getElementById("ledBrightnessValue");
    let ledSaveTimer = null;
    let lastSentBrightness = null;

    function renderLedValue(v) {
      ledValue.textContent = String(v);
    }

    function percentToRaw(p) {
      const clamped = Math.max(0, Math.min(100, p));
      return Math.round((clamped / 100) * 255);
    }

    function rawToPercent(raw) {
      const clamped = Math.max(0, Math.min(255, raw));
      return Math.round((clamped / 255) * 100);
    }

    async function loadLedBrightness() {
      try {
        const res = await fetch("/ledconf.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed");
        const j = await res.json();
        const raw = (j.ledBrightness != null) ? Number(j.ledBrightness) : 0;
        const p = rawToPercent(raw);
        ledSlider.value = p;
        renderLedValue(p);
        lastSentBrightness = raw;
      } catch {
        renderLedValue("?");
      }
    }

    async function saveLedBrightness(value) {
      const raw = percentToRaw(value);
      const body = `brightness=${encodeURIComponent(raw)}`;
      const res = await fetch("/setLedBrightness", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      if (!res.ok) throw new Error("Save failed");
    }

    function queueSaveBrightness(value) {
      if (ledSaveTimer) clearTimeout(ledSaveTimer);
      ledSaveTimer = setTimeout(async () => {
        const raw = percentToRaw(value);
        if (raw === lastSentBrightness) return;
        try {
          await saveLedBrightness(value);
          lastSentBrightness = raw;
        } catch {}
      }, 120);
    }

    ledSlider.addEventListener("input", () => {
      const v = Number(ledSlider.value);
      renderLedValue(v);
      queueSaveBrightness(v);
    });

    ledSlider.addEventListener("change", () => {
      const v = Number(ledSlider.value);
      renderLedValue(v);
      queueSaveBrightness(v);
    });

    loadLedBrightness();
  </script>
  <script src="/footer.js"></script>
</body>
</html>
