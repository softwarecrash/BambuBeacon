<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>BambuBeacon</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div id="container">
    <div id="header">
      <div class="title-stack">
        <div class="title-row">
          <a href="/"><img id="logo" src="/logo.svg" alt="Logo" /></a>
          <h1 id="deviceName">BambuBeacon</h1>
          <span class="wifi-icon" id="wifiIcon" aria-label="Wi-Fi signal" title="RSSI: ? dBm">
            <i></i><i></i><i></i><i></i>
          </span>
        </div>
        <div class="title-sub" id="deviceIp">IP: --</div>
        <div class="title-sub" id="vpnIp" style="display:none;">VPN: --</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">LED Brightness</div>
      <div class="slider-row">
        <input type="range" id="ledBrightness" min="0" max="100" step="1" />
        <div class="slider-value" id="ledBrightnessValue">--</div>
      </div>
    </div>

    <div class="panel" id="updateNotice" style="display:none;">
      <div class="panel-title">Update available</div>
      <div class="button-stack actions">
        <button class="btn" id="updateNoticeBtn" onclick="location.href='/maintenance'">Open Maintenance</button>
      </div>
    </div>

    <div class="panel" id="hmsPanel" style="display:none;">
      <div class="panel-title">HMS Alert</div>
      <div class="hms-row">
        <div class="hms-text" id="hmsText">HMS_0001_0002_0003_0004</div>
        <button class="btn btn-outline hms-btn" id="hmsIgnoreBtn">Ignore</button>
      </div>
      <div class="inline-info" id="hmsMeta">Severity: Warning  ·  Count: 1</div>
    </div>


    <div class="panel">
      <div class="panel-title">Menu</div>
      <div class="button-stack">
        <button class="btn btn-outline" onclick="location.href='/wifisetup'">Wi-Fi / Network</button>
        <button class="btn btn-outline" onclick="location.href='/printersetup'">Printer Setup</button>
        <button class="btn btn-outline" onclick="location.href='/vpn'">Wireguard Setup</button>
        <button class="btn btn-outline" onclick="location.href='/maintenance'">Maintenance</button>
        <button class="btn btn-outline" onclick="window.open('/webserial','_blank','noopener')">Debug Log</button>
      </div>
    </div>
  </div>

  <div id="toast"><span id="toast-icon">ℹ️</span><span id="toast-msg">Placeholder</span></div>
  <div class="page-footer" id="fwFooter">Firmware v? by SoftWareCrash</div>

  <script src="/backgroundCanvas.js"></script>
  <script>
    function rssiToBars(rssi) {
      if (rssi == null) return 0;
      const v = Number(rssi);
      if (v >= -55) return 4;
      if (v >= -65) return 3;
      if (v >= -75) return 2;
      if (v >= -85) return 1;
      return 0;
    }

    async function loadInfo() {
      try {
        const [infoRes, vpnRes] = await Promise.all([
          fetch("/info.json", { cache: "no-store" }),
          fetch("/api/vpn", { cache: "no-store" })
        ]);
        const j = await infoRes.json();
        document.getElementById("deviceName").textContent = j.deviceName || "BambuBeacon";
        document.getElementById("deviceIp").textContent = `IP: ${j.ip || "?"}`;
        const bars = rssiToBars(j.rssi);
        const icon = document.getElementById("wifiIcon");
        icon.setAttribute("data-bars", String(bars));
        const rssiVal = (j.rssi != null) ? String(j.rssi) : "?";
        icon.setAttribute("title", `RSSI: ${rssiVal} dBm`);

        const vpnLine = document.getElementById("vpnIp");
        if (vpnRes.ok) {
          const vpn = await vpnRes.json();
          const connected = !!(vpn && vpn.status && vpn.status.connected);
          if (connected) {
            const vpnIp = (vpn && vpn.config && vpn.config.local_ip) ? vpn.config.local_ip : "?";
            vpnLine.textContent = `VPN: ${vpnIp}`;
            vpnLine.style.display = "";
          } else {
            vpnLine.style.display = "none";
          }
        } else {
          vpnLine.style.display = "none";
        }
      } catch {
        document.getElementById("deviceIp").textContent = "IP: ?";
        document.getElementById("vpnIp").style.display = "none";
        const icon = document.getElementById("wifiIcon");
        icon.setAttribute("data-bars", "0");
        icon.setAttribute("title", "RSSI: ? dBm");
      }
    }
    loadInfo();
    loadHms();

    async function loadHms() {
      try {
        const r = await fetch("/hms.json", { cache: "no-store" });
        if (!r.ok) return;
        const j = await r.json();
        const panel = document.getElementById("hmsPanel");
        if (!j.present) {
          panel.style.display = "none";
          return;
        }
        panel.style.display = "";
        document.getElementById("hmsText").textContent = j.code || "HMS";
        const sev = (j.severity != null) ? j.severity : 0;
        const sevStr = (sev === 4) ? "Fatal" :
                       (sev === 3) ? "Error" :
                       (sev === 2) ? "Warning" :
                       (sev === 1) ? "Info" : "None";
        document.getElementById("hmsMeta").textContent =
          `Severity: ${sevStr}` + (j.count ? `  ·  Count: ${j.count}` : "");
      } catch {}
    }

    document.getElementById("hmsIgnoreBtn").addEventListener("click", async () => {
      const code = document.getElementById("hmsText").textContent.trim();
      if (!code) return;
      const body = `code=${encodeURIComponent(code)}`;
      try {
        const res = await fetch("/hmsignore/add", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body
        });
        if (res.ok) {
          loadHms();
        }
      } catch {}
    });

    async function loadUpdateNotice() {
      try {
        const r = await fetch("/ota/status", { cache: "no-store" });
        if (!r.ok) return;
        const j = await r.json();
        if (j && j.state === "update_available") {
          const panel = document.getElementById("updateNotice");
          const btn = document.getElementById("updateNoticeBtn");
          const cur = j.current || "";
          const latest = j.latest || "";
          if (cur && latest) {
            btn.textContent = `Update ${cur} → ${latest} available`;
          } else if (latest) {
            btn.textContent = `Update to ${latest} available`;
          } else {
            btn.textContent = "Update available";
          }
          panel.style.display = "";
        }
      } catch {}
    }
    loadUpdateNotice();
    setInterval(loadHms, 3000);

    const ledSlider = document.getElementById("ledBrightness");
    const ledValue = document.getElementById("ledBrightnessValue");
    let ledSaveTimer = null;
    let lastSentBrightness = null;

    function renderLedValue(v) {
      ledValue.textContent = String(v);
    }

    function percentToRaw(p) {
      const clamped = Math.max(0, Math.min(100, p));
      return Math.round((clamped / 100) * 255);
    }

    function rawToPercent(raw) {
      const clamped = Math.max(0, Math.min(255, raw));
      return Math.round((clamped / 255) * 100);
    }

    async function loadLedBrightness() {
      try {
        const res = await fetch("/ledconf.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Failed");
        const j = await res.json();
        const raw = (j.ledBrightness != null) ? Number(j.ledBrightness) : 0;
        const p = rawToPercent(raw);
        ledSlider.value = p;
        renderLedValue(p);
        lastSentBrightness = raw;
      } catch {
        renderLedValue("?");
      }
    }

    async function saveLedBrightness(value) {
      const raw = percentToRaw(value);
      const body = `brightness=${encodeURIComponent(raw)}`;
      const res = await fetch("/setLedBrightness", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });
      if (!res.ok) throw new Error("Save failed");
    }

    function queueSaveBrightness(value) {
      if (ledSaveTimer) clearTimeout(ledSaveTimer);
      ledSaveTimer = setTimeout(async () => {
        const raw = percentToRaw(value);
        if (raw === lastSentBrightness) return;
        try {
          await saveLedBrightness(value);
          lastSentBrightness = raw;
        } catch {}
      }, 120);
    }

    ledSlider.addEventListener("input", () => {
      const v = Number(ledSlider.value);
      renderLedValue(v);
      queueSaveBrightness(v);
    });

    ledSlider.addEventListener("change", () => {
      const v = Number(ledSlider.value);
      renderLedValue(v);
      queueSaveBrightness(v);
    });

    loadLedBrightness();
  </script>
  <script src="/footer.js"></script>
</body>
</html>
