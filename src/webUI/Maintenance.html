<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>BambuBeacon Maintenance</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .btn-slot{position:relative;width:100%;min-height:44px}
    .btn-slot > .btn,
    .btn-slot > .progress-wrap{position:absolute;inset:0}
    .btn-slot > .progress-wrap{margin-top:0;padding:6px 10px;display:none}
    .btn-slot .progress-bar{height:8px}
    .btn-slot .progress-label{margin-top:4px;font-size:11px}
  </style>
</head>
<body>
  <canvas id="particleCanvas"></canvas>

  <div id="container">
    <div id="header">
      <a href="/"><img id="logo" src="/logo.svg" alt="Logo" /></a>
      <h1>Maintenance</h1>
    </div>

    <div class="panel">
      <div class="panel-title">Online Update</div>

      <div class="button-stack actions">
        <div class="btn-slot">
          <button type="button" class="btn" id="otaUpdateBtn" disabled>Update Now</button>
          <div class="progress-wrap" id="otaProgressWrap" aria-live="polite">
            <div class="progress-bar"><span id="otaProgressBar"></span></div>
            <div class="progress-label">
              <span id="otaProgressText">0%</span>
              <span id="otaProgressSize">0 / 0</span>
            </div>
          </div>
        </div>
      </div>

      <div class="detailSplitter">Manual Firmware Update</div>

      <div class="button-stack actions">
        <input type="file" id="fwFile" accept=".ota,application/octet-stream" style="display:none" />
        <div class="btn-slot">
          <button type="button" class="btn" id="fwUploadBtn">Choose Firmware (.ota)</button>
          <div class="progress-wrap" id="fwProgressWrap" aria-live="polite">
            <div class="progress-bar"><span id="fwProgressBar"></span></div>
            <div class="progress-label">
              <span id="fwProgressText">0%</span>
              <span id="fwProgressSize">0 / 0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Config Backup / Restore</div>

      <div class="button-stack">
        <button type="button" class="btn btn-outline" id="backupBtn">Download Backup</button>
      </div>

      <div class="panel-title">Restore</div>

      <div class="button-stack actions">
        <input type="file" id="restoreFile" accept=".json,application/json" style="display:none" />
        <button type="button" class="btn" id="restoreBtn">Restore Config (.json)</button>
        <div class="detailSplitter">LED Test</div>
        <button type="button" class="btn btn-outline" onclick="location.href='/ledtest'">Open LED Test Page</button>
      </div>
    </div>

    <div class="panel">
      <div class="button-stack">
        <button type="button" class="btn btn-outline" onclick="location.href='/'">Back</button>
      </div>
    </div>
  </div>

  <div id="toast"><span id="toast-icon">i</span><span id="toast-msg">Placeholder</span></div>
  <div class="page-footer" id="fwFooter">Firmware v? by SoftWareCrash</div>

  <script src="/backgroundCanvas.js"></script>
  <script>
    function alertToast(type, message) {
      const toast = document.getElementById("toast");
      const icon = document.getElementById("toast-icon");
      const msg  = document.getElementById("toast-msg");

      let iconChar = "i";
      let borderColor = "rgba(255,255,255,0.18)";
      const css = getComputedStyle(document.documentElement);

      switch (String(type).toLowerCase()) {
        case "success": iconChar = "ok"; borderColor = css.getPropertyValue("--bb-primary"); break;
        case "error":   iconChar = "!";  borderColor = css.getPropertyValue("--bb-warning"); break;
        case "warning": iconChar = "!";  borderColor = css.getPropertyValue("--bb-highlight"); break;
        default:        iconChar = "i";
      }

      toast.style.borderLeftColor = (borderColor || "").trim() || "#00E5FF";
      icon.textContent = iconChar;
      msg.textContent = message;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3000);
    }

    function formatBytes(bytes) {
      if (!bytes || bytes <= 0) return "0 B";
      const units = ["B", "KB", "MB", "GB"];
      let idx = 0;
      let v = bytes;
      while (v >= 1024 && idx < units.length - 1) {
        v /= 1024;
        idx++;
      }
      return v.toFixed(v >= 10 || idx === 0 ? 0 : 1) + " " + units[idx];
    }

    function setProgress(percent, loaded, total) {
      const pct = Math.max(0, Math.min(100, percent || 0));
      document.getElementById("fwProgressBar").style.width = pct.toFixed(1) + "%";
      document.getElementById("fwProgressText").textContent = pct.toFixed(0) + "%";
      document.getElementById("fwProgressSize").textContent =
        formatBytes(loaded || 0) + " / " + formatBytes(total || 0);
    }

    function setFirmwareBusy(busy) {
      const btn = document.getElementById("fwUploadBtn");
      const wrap = document.getElementById("fwProgressWrap");
      btn.disabled = busy;
      document.getElementById("fwFile").disabled = busy;
      btn.style.display = busy ? "none" : "block";
      wrap.style.display = busy ? "block" : "none";
    }

    function setRestoreBusy(busy) {
      document.getElementById("restoreBtn").disabled = busy;
      document.getElementById("restoreFile").disabled = busy;
      document.getElementById("backupBtn").disabled = busy;
    }

    function setOtaProgress(percent, loaded, total) {
      const pct = Math.max(0, Math.min(100, percent || 0));
      document.getElementById("otaProgressBar").style.width = pct.toFixed(1) + "%";
      document.getElementById("otaProgressText").textContent = pct.toFixed(0) + "%";
      document.getElementById("otaProgressSize").textContent =
        formatBytes(loaded || 0) + " / " + formatBytes(total || 0);
    }

    let otaSuccessRedirected = false;
    function updateOtaUi(j) {
      if (!j) return;
      const updateBtn = document.getElementById("otaUpdateBtn");
      const progressWrap = document.getElementById("otaProgressWrap");

      const state = j.state || "idle";
      const busy = !!j.busy;
      const latest = j.latest || "-";
      const err = j.error || "";

      if (state === "checking") {
        updateBtn.textContent = "Checking for update...";
        updateBtn.disabled = true;
      } else if (state === "update_available") {
        updateBtn.textContent = "Update to v" + latest;
        updateBtn.disabled = busy;
      } else if (state === "downloading") {
        updateBtn.textContent = "Updating...";
        updateBtn.disabled = true;
      } else if (state === "success") {
        updateBtn.textContent = "Update complete";
        updateBtn.disabled = true;
        if (!otaSuccessRedirected) {
          otaSuccessRedirected = true;
          setOtaProgress(100, j.bytesTotal || j.bytesDone || 0, j.bytesTotal || j.bytesDone || 0);
          setTimeout(() => { location.href = "/"; }, 1200);
        }
      } else if (state === "error") {
        updateBtn.textContent = err ? "Update error" : "Update failed";
        updateBtn.disabled = true;
      } else if (state === "up_to_date") {
        updateBtn.textContent = "Up to date";
        updateBtn.disabled = true;
      } else {
        updateBtn.textContent = "Update Now";
        updateBtn.disabled = true;
      }

      const showProgress = (state === "downloading" || state === "success");
      progressWrap.style.display = showProgress ? "block" : "none";
      updateBtn.style.display = showProgress ? "none" : "block";

      setOtaProgress(j.progress || 0, j.bytesDone || 0, j.bytesTotal || 0);
    }

    let otaPollHandle = null;
    function startOtaPoll() {
      if (otaPollHandle) return;
      otaPollHandle = setInterval(fetchOtaStatus, 1500);
    }

    function stopOtaPoll() {
      if (!otaPollHandle) return;
      clearInterval(otaPollHandle);
      otaPollHandle = null;
    }

    async function fetchOtaStatus() {
      try {
        const res = await fetch("/ota/status", { cache: "no-store" });
        if (!res.ok) return;
        const j = await res.json();
        updateOtaUi(j);
        if (!j.busy) stopOtaPoll();
      } catch {
        stopOtaPoll();
      }
    }

    async function requestOtaCheck() {
      try {
        const res = await fetch("/ota/check", { method: "POST", cache: "no-store" });
        if (res.ok) {
          updateOtaUi(await res.json());
          startOtaPoll();
        } else {
          alertToast("error", "Update check failed: " + res.status);
        }
      } catch {
        alertToast("error", "Update check failed.");
      }
    }

    function startFirmwareUpload(file) {
      setFirmwareBusy(true);
      setProgress(0, 0, file.size || 0);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", "/update");
      xhr.upload.addEventListener("progress", (e) => {
        if (e.lengthComputable) {
          setProgress((e.loaded / e.total) * 100, e.loaded, e.total);
        }
      });
      xhr.onload = () => {
        if (xhr.status === 200) {
          setFirmwareBusy(true);
          setProgress(100, file.size || 0, file.size || 0);
          alertToast("success", "Firmware uploaded. Rebooting...");
          setTimeout(() => { location.href = "/"; }, 1200);
        } else {
          setFirmwareBusy(false);
          alertToast("error", "Firmware upload failed: " + xhr.status);
        }
      };
      xhr.onerror = () => {
        setFirmwareBusy(false);
        alertToast("error", "Firmware upload failed.");
      };

      const data = new FormData();
      data.append("firmware", file);
      xhr.send(data);
    }

    document.getElementById("fwUploadBtn").addEventListener("click", () => {
      if (document.getElementById("fwUploadBtn").disabled) return;
      document.getElementById("fwFile").click();
    });

    document.getElementById("fwFile").addEventListener("change", () => {
      const file = document.getElementById("fwFile").files[0];
      if (!file) return;
      startFirmwareUpload(file);
    });

    document.getElementById("backupBtn").addEventListener("click", () => {
      location.href = "/config/backup?pretty=1";
    });

    function startRestore(file) {
      const reader = new FileReader();
      reader.onload = async () => {
        try {
          setRestoreBusy(true);
          const res = await fetch("/config/restore", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: reader.result || ""
          });

          if (res.ok) {
            alertToast("success", "Config restored. Rebooting...");
          } else {
            alertToast("error", "Restore failed: " + res.status);
          }
        } catch {
          alertToast("error", "Restore failed.");
        } finally {
          setRestoreBusy(false);
        }
      };
      reader.onerror = () => alertToast("error", "Failed to read backup file.");
      reader.readAsText(file);
    }

    document.getElementById("restoreBtn").addEventListener("click", () => {
      if (document.getElementById("restoreBtn").disabled) return;
      document.getElementById("restoreFile").click();
    });

    document.getElementById("restoreFile").addEventListener("change", () => {
      const file = document.getElementById("restoreFile").files[0];
      if (!file) return;
      startRestore(file);
    });

    document.getElementById("otaUpdateBtn").addEventListener("click", async () => {
      try {
        const res = await fetch("/ota/update", { method: "POST", cache: "no-store" });
        if (res.ok) {
          updateOtaUi(await res.json());
          alertToast("success", "Update started. Downloading...");
          startOtaPoll();
        } else {
          alertToast("error", "Update start failed: " + res.status);
        }
      } catch {
        alertToast("error", "Update start failed.");
      }
    });
  </script>
  <script>
    (function () {
      fetchOtaStatus();
      requestOtaCheck();
    })();
  </script>
  <script src="/footer.js"></script>
</body>
</html>
